#!/bin/sh
# Sync mail and send notification with number of new mails.

config="$XDG_CONFIG_HOME/isync/mbsyncrc"
lastrun="$XDG_STATE_HOME/mailsync/lastrun"
maildir="$XDG_DATA_HOME/isync"

# Create lastrun if it does not exist yet.
if [ ! -d "$(dirname "$lastrun")" ]; then
    mkdir -p "$(dirname "$lastrun")"
    touch "$lastrun"
fi

# Sync mail.
mbsync -c "$config" -a

# Check for new mails and send notification if appropiate.
for account in "$maildir"/*
do
    newcount="$(find "$account/INBOX/new" -type f -newer "$lastrun" | wc -l)"
    if [ "$newcount" -eq 1 ]; then
        notify-send "$(basename "$account")" "$newcount new mail."
        paplay /usr/share/sounds/freedesktop/stereo/complete.oga
    elif [ "$newcount" -gt 1 ]; then
        notify-send "$(basename "$account")" "$newcount new mails."
        paplay /usr/share/sounds/freedesktop/stereo/complete.oga
    fi
done

# Create file to remember last run of mailsync.
touch "$lastrun"
